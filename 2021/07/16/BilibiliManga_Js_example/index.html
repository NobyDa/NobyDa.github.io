<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>记录一次Surge &amp; QuantumultX 脚本开发过程 - NobyDa&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="NobyDa&#039;s Blog"><meta name="msapplication-TileImage" content="img/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="NobyDa&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="前言 本文主要记录一次Surge或QuantumultX的脚本开发过程, 过程包括抓包、分析、调试、以及编写脚本.  记录内容为哔哩哔哩漫画积分商城自动抢券脚本."><meta property="og:type" content="blog"><meta property="og:title" content="记录一次Surge &amp; QuantumultX 脚本开发过程"><meta property="og:url" content="https://nobyda.github.io/2021/07/16/BilibiliManga_Js_example/"><meta property="og:site_name" content="NobyDa&#039;s Blog"><meta property="og:description" content="前言 本文主要记录一次Surge或QuantumultX的脚本开发过程, 过程包括抓包、分析、调试、以及编写脚本.  记录内容为哔哩哔哩漫画积分商城自动抢券脚本."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://nobyda.github.io/gallery/BilibiliManga_Js_example.jpg"><meta property="article:published_time" content="2021-07-16T12:30:00.000Z"><meta property="article:modified_time" content="2021-07-17T10:06:42.564Z"><meta property="article:author" content="NobyDa"><meta property="article:tag" content="Surge"><meta property="article:tag" content="QuantumultX"><meta property="article:tag" content="JavaScript"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/gallery/BilibiliManga_Js_example.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://nobyda.github.io/2021/07/16/BilibiliManga_Js_example/"},"headline":"NobyDa","image":["https://nobyda.github.io/gallery/BilibiliManga_Js_example.jpg"],"datePublished":"2021-07-16T12:30:00.000Z","dateModified":"2021-07-17T10:06:42.564Z","author":{"@type":"Person","name":"NobyDa"},"publisher":{"@type":"Organization","name":"NobyDa's Blog","logo":{"@type":"ImageObject","url":"https://nobyda.github.io/2021/07/16/BilibiliManga_Js_example/img/logo.svg"}},"description":"前言 本文主要记录一次Surge或QuantumultX的脚本开发过程, 过程包括抓包、分析、调试、以及编写脚本.  记录内容为哔哩哔哩漫画积分商城自动抢券脚本."}</script><link rel="canonical" href="https://nobyda.github.io/2021/07/16/BilibiliManga_Js_example/"><link rel="icon" href="/img/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="NobyDa&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-9-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/gallery/BilibiliManga_Js_example.jpg" alt="记录一次Surge &amp; QuantumultX 脚本开发过程"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-16T12:30:00.000Z" title="2021/7/16 20:30:00">2021-07-16</time>发表</span><span class="level-item"><time dateTime="2021-07-17T10:06:42.564Z" title="2021/7/17 18:06:42">2021-07-17</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E8%84%9A%E6%9C%AC%E5%BC%80%E5%8F%91/">脚本开发</a></span><span class="level-item">28 分钟读完 (大约4218个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> 次浏览</span></div></div><h1 class="title is-3 is-size-4-mobile">记录一次Surge &amp; QuantumultX 脚本开发过程</h1><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ol>
<li><p>本文主要记录一次Surge或QuantumultX的脚本开发过程, 过程包括抓包、分析、调试、以及编写脚本.</p>
</li>
<li><p>记录内容为哔哩哔哩漫画积分商城自动抢券脚本.</p>
</li>
</ol>
<span id="more"></span>

<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>作为一个合格的二次元迷, 漫画当然是少不了🧐</p>
<p>国内日漫大多都被哔哩哔哩漫画拿下版权, 然而里面大多数的日漫都需要氪金或使用漫读券才能看; </p>
<p>最近发现使用签到脚本获得的积分囤得差不多了, 换漫读券又可以省一笔, 无奈老是错过相关商品兑换时间, 一气之写了个脚本让它在规定时间内自动抢券.</p>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><h2 id="第一步-抓包"><a href="#第一步-抓包" class="headerlink" title="第一步: 抓包"></a>第一步: 抓包</h2><p>本文将使用<a target="_blank" rel="noopener" href="https://apps.apple.com/app/id1210562295">Thor</a>进行抓包, 并使用<a target="_blank" rel="noopener" href="https://apps.apple.com/app/id1357644265">Anubis</a>进行重放演示, 简单分析哔哩哔哩漫画的网络请求.</p>
<p>我们进入哔哩哔哩漫画APP后, 打开Thor开启抓包, 返回APP积分商城随便兑换一个东西, 再返回Thor关闭抓包.</p>
<p>Thor有着完备的关键字过滤,  刚刚兑换了75积分的商品, 我们可以尝试搜索请求体和响应体内的关键字, 看看是否有结果.</p>
<p><img src="/2021/07/16/BilibiliManga_Js_example/thor-exchange-filter.jpg"></p>
<p>搜索后一个名为Pointshop/Exchange的请求直接映入眼下, 翻译成中文大意为 店铺/兑换, 很直观.</p>
<p><img src="/2021/07/16/BilibiliManga_Js_example/thor-exchange-url.JPEG"></p>
<p>我们进一步查看该请求的请求体, 以及响应体.</p>
<p><img src="/2021/07/16/BilibiliManga_Js_example/thor-exchange-body.JPEG"></p>
<p>可以很直观的看到请求体中的各种参数, product_id 表示兑换的商品, product_num 表示兑换的数量, point 表示消耗的积分.</p>
<p>响应体中code为0表示兑换成功, expire_day表示有效期, remain_amount表示该商品库存.</p>
<p>我们把该请求使用anubis重放, 看看该接口是否有效.</p>
<p><img src="/2021/07/16/BilibiliManga_Js_example/thor-exchange-anubis.JPEG"></p>
<p>可以看到重放后该接口是可用的, 商品剩余数量相应减少, 返回app查看账号积分也减少了75并收到商品.</p>
<p>之后我们看一下请求体中的product_id的商品id是怎么来的, 返回Thor之前抓到的包, 筛选器搜索1048关键字.</p>
<p><img src="/2021/07/16/BilibiliManga_Js_example/thor-exchange-list.JPEG"></p>
<p>搜索后有一个叫ListProduct的请求, 翻译成中文大意为商品清单, 我们点开响应体可以看到一个商品名为”小智怪谈”的商品, 商品id为1048, 商品库存为3796, 正是我之前所兑换的商品.</p>
<p>该接口使用anubis重放后并没有什么问题; </p>
<p>最后还差一个查询账户积分的接口, 我们使用Thor筛选器搜索响应关键字, 开启抓包之前我的账户有3172积分, 则尝试搜索3172</p>
<p><img src="/2021/07/16/BilibiliManga_Js_example/thor-exchange-point.JPEG"></p>
<p>可以看到有一个叫GetUserPoint的请求, 翻译成中文大意为获取用户积分, 点开响应后我们可以看到查询到的账户积分.</p>
<h2 id="第二步-分析"><a href="#第二步-分析" class="headerlink" title="第二步: 分析"></a>第二步: 分析</h2><p>我们抓到接口后使用anubis重放进一步分析:</p>
<ol>
<li>精简参数, 分析url中的device之类的参数是否必须、是否验证Cookie、请求体是否必须, 以减少脚本编写工作量.</li>
<li>分析各种情况下接口返回不同响应的可能性, 供脚本正确判断.</li>
</ol>
<h3 id="分析查询积分接口"><a href="#分析查询积分接口" class="headerlink" title="分析查询积分接口"></a>分析查询积分接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">原接口<br>https://manga.bilibili.com/twirp/pointshop.v1.Pointshop/GetUserPoint?device=h5&amp;platform=web<br></code></pre></td></tr></table></figure>

<p>经过各种重放后可得知</p>
<ol>
<li>接口可省略url中的参数.</li>
<li>请求体可省略.</li>
<li>必须使用POST方法.</li>
<li>使用请求头中的Cookie字段作为用户鉴权, 一些非必要字段也可省略.</li>
</ol>
<p>带有效Cookie响应体内容为</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;code&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">&quot;msg&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;point&quot;</span>: <span class="hljs-string">&quot;用户实际积分数量&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Cookie失效后响应体内容为</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;code&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">&quot;msg&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;point&quot;</span>: <span class="hljs-string">&quot;0&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="分析查询商品接口"><a href="#分析查询商品接口" class="headerlink" title="分析查询商品接口"></a>分析查询商品接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">原接口<br>https://manga.bilibili.com/twirp/pointshop.v1.Pointshop/ListProduct?device=h5&amp;platform=web<br></code></pre></td></tr></table></figure>

<p>经过各种重放后可得知</p>
<ol>
<li>接口可省略url中的参数.</li>
<li>请求体可省略.</li>
<li>必须使用POST方法.</li>
<li>无需用户鉴权.</li>
</ol>
<p>响应体:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;code&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">&quot;msg&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: [&#123;<br>    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">195</span>,<br>    <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-number">7</span>,<br>    <span class="hljs-attr">&quot;title&quot;</span>: <span class="hljs-string">&quot;积分兑换&quot;</span>,<br>    <span class="hljs-attr">&quot;image&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-attr">&quot;amount&quot;</span>: <span class="hljs-number">15999</span>,<br>    <span class="hljs-attr">&quot;cost&quot;</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">&quot;real_cost&quot;</span>: <span class="hljs-number">100</span>,<br>    <span class="hljs-attr">&quot;remain_amount&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;comic_id&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;limits&quot;</span>: [],<br>    <span class="hljs-attr">&quot;discount&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;product_type&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;pendant_url&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-attr">&quot;pendant_expire&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;exchange_limit&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;address_deadline&quot;</span>: <span class="hljs-string">&quot;0001-01-01T00:00:00Z&quot;</span>,<br>    <span class="hljs-attr">&quot;act_type&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;has_exchanged&quot;</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">&quot;main_coupon_deadline&quot;</span>: <span class="hljs-string">&quot;0001-01-01T00:00:00Z&quot;</span>,<br>    <span class="hljs-attr">&quot;deadline&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-attr">&quot;point&quot;</span>: <span class="hljs-string">&quot;0&quot;</span><br>  &#125;]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上非实际响应, 其他商品过多, 已省略.</p>
<h3 id="分析兑换商品接口"><a href="#分析兑换商品接口" class="headerlink" title="分析兑换商品接口"></a>分析兑换商品接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">原接口<br>https://manga.bilibili.com/twirp/pointshop.v1.Pointshop/Exchange?device=h5&amp;platform=web<br></code></pre></td></tr></table></figure>

<p>经过各种重放后可得知</p>
<ol>
<li><p>接口可省略url中的参数.</p>
</li>
<li><p>请求体需带有</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;product_id&quot;</span>: <span class="hljs-string">&quot;商品ID&quot;</span>,<br>  <span class="hljs-attr">&quot;product_num&quot;</span>: <span class="hljs-string">&quot;商品兑换数量&quot;</span>,<br>  <span class="hljs-attr">&quot;point&quot;</span>: <span class="hljs-string">&quot;总消耗积分数量&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>必须使用POST方法.</p>
</li>
<li><p>使用请求头中的Cookie字段作为用户鉴权, 一些非必要字段也可省略.</p>
</li>
</ol>
<p>兑换成功响应体内容为</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;code&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">&quot;msg&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-attr">&quot;data&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;商品使用ID&quot;</span>,<br>    <span class="hljs-attr">&quot;expire_day&quot;</span>: <span class="hljs-string">&quot;商品过期剩余天&quot;</span>,<br>    <span class="hljs-attr">&quot;remain_amount&quot;</span>: <span class="hljs-string">&quot;商品库存&quot;</span>,<br>    <span class="hljs-attr">&quot;deadline&quot;</span>: <span class="hljs-string">&quot;0001-01-01T00:00:00Z&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="第三步-编写脚本"><a href="#第三步-编写脚本" class="headerlink" title="第三步: 编写脚本"></a>第三步: 编写脚本</h2><blockquote>
<p><strong>什么是函数</strong></p>
</blockquote>
<p>函数是 JavaScript 中的基本组件之一, 一个函数是 JavaScript过程中执行一组任务或计算值的语句.</p>
<p>本文的抢券脚本将定义各种函数以方便统一调用.</p>
<p>查看 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Functions">JavaScript 函数详细参考文档</a> 了解更多.</p>
<h3 id="应用兼容"><a href="#应用兼容" class="headerlink" title="应用兼容"></a>应用兼容</h3><p>由于该脚本针对多平台, 脚本的写法需要同时兼容Surge或QuanX之类的客户端, 那么我们就需要写一个兼容函数让它在不同环境下也能被正确执行.</p>
<p>以下函数兼容Surge、QX、Loon中的部分API, 包括持久化读取、通知、POST请求</p>
<figure class="highlight javascript"><figcaption><span>兼容函数 (点击左边箭头展开) >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><br><span class="hljs-comment">// const $ = new nobyda(); </span><br><span class="hljs-comment">// 发送一个通知: $.notify(&#x27;title&#x27;, &#x27;subtitle&#x27;, &#x27;message&#x27;)</span><br><span class="hljs-comment">// 持久化读取: $.read(&#x27;Key&#x27;)</span><br><span class="hljs-comment">// POST请求: $.post(url&lt;Object&gt;,callback&lt;Function&gt;)</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nobyda</span>(<span class="hljs-params"></span>) </span>&#123;<br>	<span class="hljs-keyword">const</span> isSurge = <span class="hljs-keyword">typeof</span> $httpClient != <span class="hljs-string">&quot;undefined&quot;</span>;<br>	<span class="hljs-keyword">const</span> isQuanX = <span class="hljs-keyword">typeof</span> $task != <span class="hljs-string">&quot;undefined&quot;</span>;<br>	<span class="hljs-keyword">const</span> isNode = <span class="hljs-keyword">typeof</span> <span class="hljs-built_in">require</span> == <span class="hljs-string">&quot;function&quot;</span>;<br>	<span class="hljs-keyword">const</span> node = (<span class="hljs-function">() =&gt;</span> &#123;<br>		<span class="hljs-keyword">if</span> (isNode) &#123;<br>			<span class="hljs-keyword">const</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;request&#x27;</span>);<br>			<span class="hljs-keyword">return</span> &#123;<br>				request<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>		&#125;<br>	&#125;)()<br>	<span class="hljs-keyword">const</span> adapterStatus = <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> &#123;<br>		<span class="hljs-keyword">if</span> (response) &#123;<br>			<span class="hljs-keyword">if</span> (response.status) &#123;<br>				response[<span class="hljs-string">&quot;statusCode&quot;</span>] = response.status<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response.statusCode) &#123;<br>				response[<span class="hljs-string">&quot;status&quot;</span>] = response.statusCode<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> response<br>	&#125;<br>	<span class="hljs-built_in">this</span>.read = <span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> &#123;<br>		<span class="hljs-keyword">if</span> (isQuanX) <span class="hljs-keyword">return</span> $prefs.valueForKey(key)<br>		<span class="hljs-keyword">if</span> (isSurge) <span class="hljs-keyword">return</span> $persistentStore.read(key)<br>	&#125;<br>	<span class="hljs-built_in">this</span>.notify = <span class="hljs-function">(<span class="hljs-params">title, subtitle, message</span>) =&gt;</span> &#123;<br>		<span class="hljs-keyword">if</span> (isQuanX) $notify(title, subtitle, message)<br>		<span class="hljs-keyword">if</span> (isSurge) $notification.post(title, subtitle, message)<br>		<span class="hljs-keyword">if</span> (isNode) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">$&#123;title&#125;</span>\n<span class="hljs-subst">$&#123;subtitle&#125;</span>\n<span class="hljs-subst">$&#123;message&#125;</span>`</span>)<br>	&#125;<br>	<span class="hljs-built_in">this</span>.post = <span class="hljs-function">(<span class="hljs-params">options, callback</span>) =&gt;</span> &#123;<br>		options.headers[<span class="hljs-string">&#x27;User-Agent&#x27;</span>] = <span class="hljs-string">&#x27;User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 13_6_1 like Mac OS X) AppleWebKit/609.3.5.0.2 (KHTML, like Gecko) Mobile/17G80 BiliApp/822 mobi_app/ios_comic channel/AppStore BiliComic/822&#x27;</span><br>		<span class="hljs-keyword">if</span> (isQuanX) &#123;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options == <span class="hljs-string">&quot;string&quot;</span>) options = &#123;<br>				<span class="hljs-attr">url</span>: options<br>			&#125;<br>			options[<span class="hljs-string">&quot;method&quot;</span>] = <span class="hljs-string">&quot;POST&quot;</span><br>			$task.fetch(options).then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> &#123;<br>				callback(<span class="hljs-literal">null</span>, adapterStatus(response), response.body)<br>			&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> callback(reason.error, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>))<br>		&#125;<br>		<span class="hljs-keyword">if</span> (isSurge) &#123;<br>			options.headers[<span class="hljs-string">&#x27;X-Surge-Skip-Scripting&#x27;</span>] = <span class="hljs-literal">false</span><br>			$httpClient.post(options, <span class="hljs-function">(<span class="hljs-params">error, response, body</span>) =&gt;</span> &#123;<br>				callback(error, adapterStatus(response), body)<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">if</span> (isNode) &#123;<br>			node.request.post(options, <span class="hljs-function">(<span class="hljs-params">error, response, body</span>) =&gt;</span> &#123;<br>				callback(error, adapterStatus(response), body)<br>			&#125;)<br>		&#125;<br>	&#125;<br>	<span class="hljs-built_in">this</span>.done = <span class="hljs-function">() =&gt;</span> &#123;<br>		<span class="hljs-keyword">if</span> (isQuanX || isSurge) &#123;<br>			$done()<br>		&#125;<br>	&#125;<br>&#125;;<br><br></code></pre></td></tr></table></figure>



<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><p>写好兼容函数后我们先定义一些全局变量, 供所有函数调用.</p>
<figure class="highlight javascript"><figcaption><span>全局变量</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 新建一个实例对象, 把兼容函数定义到$中, 以便统一调用</span><br><span class="hljs-keyword">let</span> $ = <span class="hljs-keyword">new</span> nobyda();<br><br><span class="hljs-comment">// 读取兑换商品名, 默认兑换积分商城中的&quot;积分兑换&quot;; 该接口为BoxJs预留, 以便修改</span><br><span class="hljs-keyword">let</span> productName = $.read(<span class="hljs-string">&#x27;BM_ProductName&#x27;</span>) || <span class="hljs-string">&#x27;积分兑换&#x27;</span>;<br><br><span class="hljs-comment">// 读取兑换数量, 默认兑换最大值; 该接口为BoxJs预留, 以便修改</span><br><span class="hljs-keyword">let</span> productNum = $.read(<span class="hljs-string">&#x27;BM_ProductNum&#x27;</span>);<br><br><span class="hljs-comment">// 读取循环抢购次数, 默认100次; 该接口为BoxJs预留, 以便修改</span><br><span class="hljs-keyword">let</span> exchangeNum = $.read(<span class="hljs-string">&#x27;BM_ExchangeNum&#x27;</span>) || <span class="hljs-string">&#x27;100&#x27;</span>;<br><br><span class="hljs-comment">// 读取哔哩哔哩漫画签到脚本所使用的Cookie</span><br><span class="hljs-keyword">let</span> cookie = $.read(<span class="hljs-string">&#x27;CookieBM&#x27;</span>);<br><br><span class="hljs-comment">// 预留的空对象, 便于函数之间读取数据</span><br><span class="hljs-keyword">let</span> user = &#123;&#125;;<br></code></pre></td></tr></table></figure>



<h3 id="查询积分"><a href="#查询积分" class="headerlink" title="查询积分"></a>查询积分</h3><p>脚本开始时首先要做的是查询账号里的积分是否符合兑换要求.</p>
<p>该函数调用时, 将执行查询积分, 如果查询用户积分成功, 则将查询到的积分赋值到<a href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F">全局变量</a>中, 供其他函数读取.</p>
<figure class="highlight javascript"><figcaption><span>查询积分函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GetUserPoint</span>(<span class="hljs-params"></span>) </span>&#123;<br>	<span class="hljs-keyword">const</span> pointUrl = &#123; <span class="hljs-comment">//查询积分接口</span><br>		<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://manga.bilibili.com/twirp/pointshop.v1.Pointshop/GetUserPoint&#x27;</span>,<br>		<span class="hljs-attr">headers</span>: &#123; <span class="hljs-comment">//请求头</span><br>			<span class="hljs-string">&#x27;Cookie&#x27;</span>: cookie <span class="hljs-comment">//用户鉴权Cookie</span><br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> &#123; <span class="hljs-comment">//主函数返回Promise实例对象, 以便后续调用时可以实现顺序执行异步函数</span><br>		$.post(pointUrl, <span class="hljs-function">(<span class="hljs-params">error, resp, data</span>) =&gt;</span> &#123; <span class="hljs-comment">//使用post请求查询, 再使用回调函数处理返回的结果</span><br>			<span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">//使用try方法捕获可能出现的代码异常</span><br>				<span class="hljs-keyword">if</span> (error) &#123;<br>					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(error); <span class="hljs-comment">//如果请求失败, 例如无法联网, 则抛出一个异常</span><br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					<span class="hljs-keyword">const</span> body = <span class="hljs-built_in">JSON</span>.parse(data); <span class="hljs-comment">//解析响应体json并转化为对象</span><br>					<span class="hljs-keyword">if</span> (body.code == <span class="hljs-number">0</span> &amp;&amp; body.data) &#123; <span class="hljs-comment">//如果响应体为预期格式</span><br>						user.point = <span class="hljs-built_in">parseInt</span>(body.data.point); <span class="hljs-comment">//把查询的积分赋值到全局变量user中</span><br>						<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n当前积分: <span class="hljs-subst">$&#123;body.data.point&#125;</span>`</span>); <span class="hljs-comment">//打印日志</span><br>					&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//否则抛出一个异常</span><br>						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(body.msg || data);<br>					&#125;<br>				&#125;<br>			&#125; <span class="hljs-keyword">catch</span> (e) &#123; <span class="hljs-comment">//接住try代码块中抛出的异常, 并打印日志</span><br>				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n查询积分: 失败\n出现错误: <span class="hljs-subst">$&#123;e.message&#125;</span>`</span>);<br>			&#125; <span class="hljs-keyword">finally</span> &#123; <span class="hljs-comment">//finally语句在try和catch之后无论有无异常都会执行</span><br>				resolve(); <span class="hljs-comment">//异步操作成功时调用, 将Promise对象的状态标记为&quot;成功&quot;, 表示已完成查询积分</span><br>			&#125;<br>		&#125;)<br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="查询商品"><a href="#查询商品" class="headerlink" title="查询商品"></a>查询商品</h3><p>根据前面的分析, 我们兑换商品时需要相应的商品ID.</p>
<p>该函数调用时, 将执行查询操作, 并根据<a href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F">全局变量</a>所定义的商品名进行过滤, 过滤后的内容仅包含相关商品的基本信息, 例如商品ID、兑换价格、库存等, 再把过滤后的内容赋值到<a href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F">全局变量</a>中, 供其他函数读取.</p>
<figure class="highlight javascript"><figcaption><span>查询商品函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ListProduct</span>(<span class="hljs-params"></span>) </span>&#123;<br>	<span class="hljs-keyword">const</span> listUrl = &#123; <span class="hljs-comment">//查询商品接口</span><br>		<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://manga.bilibili.com/twirp/pointshop.v1.Pointshop/ListProduct&#x27;</span>,<br>		<span class="hljs-attr">headers</span>: &#123;&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> &#123; <span class="hljs-comment">//主函数返回Promise实例对象, 以便后续调用时可以实现顺序执行异步函数</span><br>		$.post(listUrl, <span class="hljs-function">(<span class="hljs-params">error, resp, data</span>) =&gt;</span> &#123; <span class="hljs-comment">//使用post请求查询, 再使用回调函数处理返回的结果</span><br>			<span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">//使用try方法捕获可能出现的代码异常</span><br>				<span class="hljs-keyword">if</span> (error) &#123;<br>					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(error); <span class="hljs-comment">//如果请求失败, 例如无法联网, 则抛出一个异常</span><br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					<span class="hljs-keyword">const</span> body = <span class="hljs-built_in">JSON</span>.parse(data); <span class="hljs-comment">//解析响应体json并转化为对象</span><br>					<span class="hljs-keyword">if</span> (body.code == <span class="hljs-number">0</span> &amp;&amp; body.data.length &gt;= <span class="hljs-number">1</span>) &#123; <span class="hljs-comment">//如果接口正常返回商品信息</span><br>						<span class="hljs-comment">// 按全局变量所填写的商品名进行过滤, 并把商品信息赋值到全局变量user中</span><br>						user.list = body.data.filter(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.title == productName).pop();<br>						<span class="hljs-keyword">if</span> (!user.list) &#123;<br>							<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;请检查商品名&#x27;</span>); <span class="hljs-comment">//如果填错商品名则抛出一个异常</span><br>						&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//否则打印日志</span><br>							<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n查询商品: <span class="hljs-subst">$&#123;productName&#125;</span>\n商品库存: <span class="hljs-subst">$&#123;user.list.remain_amount&#125;</span>`</span>)<br>						&#125;<br>					&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//否则抛出一个异常</span><br>						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;无商品列表&#x27;</span>);<br>					&#125;<br>				&#125;<br>			&#125; <span class="hljs-keyword">catch</span> (e) &#123; <span class="hljs-comment">//接住try代码块中抛出的异常并打印日志</span><br>				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n查询商品: <span class="hljs-subst">$&#123;productName&#125;</span>\n出现错误: <span class="hljs-subst">$&#123;e.message&#125;</span>`</span>);<br>			&#125; <span class="hljs-keyword">finally</span> &#123; <span class="hljs-comment">//finally语句在try和catch之后无论有无异常都会执行</span><br>				resolve(); <span class="hljs-comment">//异步操作成功时调用, 将Promise对象的状态标记为&quot;成功&quot;, 表示已完成查询商品</span><br>			&#125;<br>		&#125;)<br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="兑换商品"><a href="#兑换商品" class="headerlink" title="兑换商品"></a>兑换商品</h3><p>兑换商品分为两个函数, 第一个函数调用后, 将根据前面查询到的数据进行判断, 如果商品有库存并且用户积分大于100, 则根据<a href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F">全局变量</a>所定义的循环次数, 暴力调用第二个”请求”函数 (默认循环100次)</p>
<figure class="highlight javascript"><figcaption><span>兑换商品函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ExchangeProduct</span>(<span class="hljs-params"></span>) </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-keyword">async</span> (resolve) =&gt; &#123; <span class="hljs-comment">//主函数返回Promise实例对象, 以便后续调用时可以实现顺序执行异步函数, 该实例函数带有async关键字, 表示里面有异步操作, 例如可使用await得到异步结果</span><br>		<span class="hljs-keyword">if</span> (user.list &amp;&amp; user.list.remain_amount &amp;&amp; user.point &gt;= <span class="hljs-number">100</span>) &#123; <span class="hljs-comment">//如果商品有库存并且用户积分大于100则进行抢购</span><br>			<span class="hljs-comment">//兑换商品数量(用户积分 除与 商品单价得到兑换数量), 并转成整数; 默认兑换最大数量</span><br>			<span class="hljs-keyword">const</span> num = <span class="hljs-built_in">parseInt</span>(productNum || (user.point / user.list.real_cost));<br>			<span class="hljs-keyword">const</span> exchangeUrl = &#123;<br>				<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://manga.bilibili.com/twirp/pointshop.v1.Pointshop/Exchange&#x27;</span>, <span class="hljs-comment">//兑换商品接口</span><br>				<span class="hljs-attr">headers</span>: &#123; <span class="hljs-comment">//请求头</span><br>					<span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>, <span class="hljs-comment">//声明请求体数据格式</span><br>					<span class="hljs-string">&#x27;Cookie&#x27;</span>: cookie <span class="hljs-comment">//用户鉴权Cookie</span><br>				&#125;,<br>				<span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify(&#123; <span class="hljs-comment">//请求体转成字符串类型</span><br>					<span class="hljs-attr">product_id</span>: user.list.id, <span class="hljs-comment">//兑换的商品id</span><br>					<span class="hljs-attr">product_num</span>: num, <span class="hljs-comment">//兑换的商品数量</span><br>					<span class="hljs-attr">point</span>: num * user.list.real_cost <span class="hljs-comment">//消耗的积分总数 (兑换数量乘单价得到积分总数)</span><br>				&#125;)<br>			&#125;;<br>			<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">parseInt</span>(exchangeNum); i++) &#123; <span class="hljs-comment">//根据全局变量定义的次数, 暴力循环抢购</span><br>				<span class="hljs-comment">// 循环内调用另一个抢购函数, 并传入请求、第几次循环、兑换数量等参数, </span><br>				<span class="hljs-comment">// 使用await关键字声明, 表示需要等待每一次的执行结果</span><br>				<span class="hljs-keyword">const</span> run = <span class="hljs-keyword">await</span> startExchange(exchangeUrl, i, num);<br>				<span class="hljs-keyword">if</span> (run) &#123;<br>					<span class="hljs-keyword">break</span>; <span class="hljs-comment">//如果函数返回布尔值true, 则跳出循环, 脚本结束</span><br>				&#125;<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//商品无库存或用户积分小于100等情况, 则不执行抢购, 脚本结束</span><br>			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n抢购终止: 不具备兑换条件`</span>); <span class="hljs-comment">//打印日志</span><br>		&#125;<br>		resolve(); <span class="hljs-comment">//将主函数的Promise对象状态标记为&quot;成功&quot;, 表示已完成抢购任务</span><br>	&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startExchange</span>(<span class="hljs-params">url, item, amount</span>) </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> &#123; <span class="hljs-comment">//主函数返回Promise实例对象, 以便后续调用时可以实现顺序执行异步函数</span><br>		$.post(url, <span class="hljs-function">(<span class="hljs-params">error, resp, data</span>) =&gt;</span> &#123; <span class="hljs-comment">//使用post请求查询, 再使用回调函数处理返回的结果</span><br>			<span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">//使用try方法捕获可能出现的代码异常</span><br>				<span class="hljs-keyword">if</span> (error) &#123;<br>					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(error); <span class="hljs-comment">//如果请求失败, 例如无法联网, 则抛出一个异常</span><br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					<span class="hljs-keyword">const</span> body = <span class="hljs-built_in">JSON</span>.parse(data); <span class="hljs-comment">//解析响应体json并转化为对象</span><br>					<span class="hljs-keyword">if</span> (body.code == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//如果抢购成功, 则输出日志和通知</span><br>						<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n抢购成功: 第<span class="hljs-subst">$&#123;item+<span class="hljs-number">1</span>&#125;</span>次\n抢购数量: <span class="hljs-subst">$&#123;amount&#125;</span>\n消耗积分: <span class="hljs-subst">$&#123;amount * user.list.real_cost&#125;</span>`</span>);<br>						$.notify(<span class="hljs-string">&#x27;哔哩哔哩漫画抢券&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`&quot;<span class="hljs-subst">$&#123;productName&#125;</span>&quot;抢购成功, 数量: <span class="hljs-subst">$&#123;amount&#125;</span>, 消耗积分: <span class="hljs-subst">$&#123;amount * user.list.real_cost&#125;</span>`</span>);<br>						resolve(<span class="hljs-literal">true</span>); <span class="hljs-comment">//将Promise对象的状态标记为&quot;成功&quot;, 然后返回一个布尔值true用于跳出循环</span><br>					&#125; <span class="hljs-keyword">else</span> &#123;<br>						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(body.msg || <span class="hljs-string">&#x27;未知&#x27;</span>); <span class="hljs-comment">//抢购失败则抛出异常</span><br>					&#125;<br>				&#125;<br>			&#125; <span class="hljs-keyword">catch</span> (e) &#123; <span class="hljs-comment">//接住try代码块中抛出的异常并打印日志</span><br>				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">`\n抢购失败: 第<span class="hljs-subst">$&#123;item+<span class="hljs-number">1</span>&#125;</span>次\n失败原因: <span class="hljs-subst">$&#123;e.message&#125;</span>`</span>);<br>				resolve(); <span class="hljs-comment">//将Promise对象的状态标记为&quot;成功&quot;, 但不返回任何值, 表示继续循环抢购</span><br>			&#125;<br>		&#125;)<br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="统一调用"><a href="#统一调用" class="headerlink" title="统一调用"></a>统一调用</h3><p>写好函数后, 如果不进行调用, 那么代码是无法被运行的.</p>
<p>在javascript中, 代码的执行顺序很重要, 我们的需求是先同时查询积分和商品, 再抢购, 最后退出脚本.</p>
<p>以下匿名函数将按我们预期的顺序执行.</p>
<figure class="highlight javascript"><figcaption><span>匿名异步函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript">(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123; <span class="hljs-comment">// 立即运行的匿名异步函数</span><br>	<span class="hljs-comment">// 使用await关键字声明, 表示以同步方式执行异步函数, 可以简单理解为顺序执行</span><br>	<span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all([ <span class="hljs-comment">//该方法用于将多个实例包装成一个新的实例, 可以简单理解为同时调用函数, 以进一步提高执行速度</span><br>		GetUserPoint(), <span class="hljs-comment">//查询积分函数</span><br>		ListProduct() <span class="hljs-comment">//查询商品函数</span><br>	]);<br>	<span class="hljs-keyword">await</span> ExchangeProduct(); <span class="hljs-comment">//上面的查询都完成后, 则执行抢购</span><br>	$.done(); <span class="hljs-comment">//抢购完成后调用Surge、QX内部特有的函数, 用于退出脚本执行</span><br>&#125;)();<br></code></pre></td></tr></table></figure>

<h2 id="第四步-配置任务"><a href="#第四步-配置任务" class="headerlink" title="第四步: 配置任务"></a>第四步: 配置任务</h2><p>我们写好脚本后, 就可以在Surge或QuantumultX里配置定时任务让它在规定时间内执行该脚本.</p>
<p>以下将用Surge进行演示</p>
<blockquote>
<p><strong>编辑Surge配置文件, 在[Script]段落放入以下脚本</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">哔哩哔哩漫画抢券 = type=cron,cronexp=&quot;10,20,30 0 12 * * *&quot;,wake-system=1,timeout=60,script-path=https://raw.githubusercontent.com/NobyDa/Script/master/Bilibili-DailyBonus/ExchangePoints.js<br></code></pre></td></tr></table></figure>

<p>因为积分商城刷新时间在每天中午12点, 则以上配置将在每天中午12:00:10、12:00:20、12:00:30分别执行一次.</p>
<p>有几点需要注意</p>
<ol>
<li><p>脚本抢购完成后注意禁用, 避免每天无意义的运行</p>
</li>
<li><p>脚本需要使用<a target="_blank" rel="noopener" href="https://github.com/NobyDa/Script/blob/master/Bilibili-DailyBonus/Manga.js">哔哩哔哩签到脚本</a>获取Cookie后方可使用.</p>
</li>
<li><p>默认兑换积分商城中的 “积分兑换”; 可自行修改.</p>
</li>
<li><p>兑换数量为用户积分可兑换的最大值; 可自行修改.</p>
</li>
</ol>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>本文又是一篇专业性极强的文章, 有的同学可能又要头大了; 写这篇文章动机主要是为了让读者了解一个需求的实现过程, 脚本里也有大量注释供读者理解思路.</p>
<p>这个需求说难也不太难, 就是抓几个接口去模拟用户兑换的行为. 当然还是需要有一定的抓包经验和javascript功底才行; 我的javascript功底也就勉勉强强够我写几个简单需求.</p>
<p>虽然本文看起来比较水, 但还是建议初学者照着本文去理解抓包思路, 以及脚本的执行逻辑.</p>
<p>最后, 提前祝大家周末愉快!</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>记录一次Surge &amp; QuantumultX 脚本开发过程</p><p><a href="https://nobyda.github.io/2021/07/16/BilibiliManga_Js_example/">https://nobyda.github.io/2021/07/16/BilibiliManga_Js_example/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>NobyDa</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-07-16</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-07-17</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Surge/">Surge</a><a class="link-muted mr-2" rel="tag" href="/tags/QuantumultX/">QuantumultX</a><a class="link-muted mr-2" rel="tag" href="/tags/JavaScript/">JavaScript</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=60bb78906cfa7d00118e7e9e&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/donates.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/07/24/Bahamut_daily_bonus_js_example/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">巴哈姆特自动签到脚本（适配/开发实例）</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/06/08/Surge_network_firewall/"><span class="level-item">使用Surge脚本 &amp; 逻辑规则建立联网防火墙</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "9e7c6c8d6592a3b5bcd758b515f40ba4",
            repo: "NobyDa.github.io",
            owner: "NobyDa",
            clientID: "84cc10757e7c7631cf71",
            clientSecret: "095f8b47cbdb5b1ef38709e44e7186cd951362b9",
            admin: ["NobyDa"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "first",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-3-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">1</span><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#背景"><span class="level-left"><span class="level-item">2</span><span class="level-item">背景</span></span></a></li><li><a class="level is-mobile" href="#过程"><span class="level-left"><span class="level-item">3</span><span class="level-item">过程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#第一步-抓包"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">第一步: 抓包</span></span></a></li><li><a class="level is-mobile" href="#第二步-分析"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">第二步: 分析</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#分析查询积分接口"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">分析查询积分接口</span></span></a></li><li><a class="level is-mobile" href="#分析查询商品接口"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">分析查询商品接口</span></span></a></li><li><a class="level is-mobile" href="#分析兑换商品接口"><span class="level-left"><span class="level-item">3.2.3</span><span class="level-item">分析兑换商品接口</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第三步-编写脚本"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">第三步: 编写脚本</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#应用兼容"><span class="level-left"><span class="level-item">3.3.1</span><span class="level-item">应用兼容</span></span></a></li><li><a class="level is-mobile" href="#全局变量"><span class="level-left"><span class="level-item">3.3.2</span><span class="level-item">全局变量</span></span></a></li><li><a class="level is-mobile" href="#查询积分"><span class="level-left"><span class="level-item">3.3.3</span><span class="level-item">查询积分</span></span></a></li><li><a class="level is-mobile" href="#查询商品"><span class="level-left"><span class="level-item">3.3.4</span><span class="level-item">查询商品</span></span></a></li><li><a class="level is-mobile" href="#兑换商品"><span class="level-left"><span class="level-item">3.3.5</span><span class="level-item">兑换商品</span></span></a></li><li><a class="level is-mobile" href="#统一调用"><span class="level-left"><span class="level-item">3.3.6</span><span class="level-item">统一调用</span></span></a></li></ul></li><li><a class="level is-mobile" href="#第四步-配置任务"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">第四步: 配置任务</span></span></a></li></ul></li><li><a class="level is-mobile" href="#结语"><span class="level-left"><span class="level-item">4</span><span class="level-item">结语</span></span></a></li></ul></div></div><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"></a><p class="is-size-7"><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span><br><span>&copy; 2024 NobyDa's Blog is</span> powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>