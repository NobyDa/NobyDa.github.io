<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>巴哈姆特自动签到脚本（适配/开发实例） - NobyDa&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="NobyDa&#039;s Blog"><meta name="msapplication-TileImage" content="img/avatar.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="NobyDa&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="简介本文主要记录一次从巴哈姆特自动签到脚本（油猴）适配至可供Surge、QuantumultX运行的开发过程。"><meta property="og:type" content="blog"><meta property="og:title" content="巴哈姆特自动签到脚本（适配/开发实例）"><meta property="og:url" content="https://nobyda.github.io/2021/07/24/Bahamut_daily_bonus_js_example/"><meta property="og:site_name" content="NobyDa&#039;s Blog"><meta property="og:description" content="简介本文主要记录一次从巴哈姆特自动签到脚本（油猴）适配至可供Surge、QuantumultX运行的开发过程。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://nobyda.github.io/gallery/Bahamut_daily_bonus_js_example.png"><meta property="article:published_time" content="2021-07-24T12:30:00.000Z"><meta property="article:modified_time" content="2021-07-24T12:35:06.581Z"><meta property="article:author" content="NobyDa"><meta property="article:tag" content="Surge"><meta property="article:tag" content="QuantumultX"><meta property="article:tag" content="JavaScript"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/gallery/Bahamut_daily_bonus_js_example.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://nobyda.github.io/2021/07/24/Bahamut_daily_bonus_js_example/"},"headline":"NobyDa","image":["https://nobyda.github.io/gallery/Bahamut_daily_bonus_js_example.png"],"datePublished":"2021-07-24T12:30:00.000Z","dateModified":"2021-07-24T12:35:06.581Z","author":{"@type":"Person","name":"NobyDa"},"publisher":{"@type":"Organization","name":"NobyDa's Blog","logo":{"@type":"ImageObject","url":"https://nobyda.github.io/2021/07/24/Bahamut_daily_bonus_js_example/img/logo.svg"}},"description":"简介本文主要记录一次从巴哈姆特自动签到脚本（油猴）适配至可供Surge、QuantumultX运行的开发过程。"}</script><link rel="canonical" href="https://nobyda.github.io/2021/07/24/Bahamut_daily_bonus_js_example/"><link rel="icon" href="/img/avatar.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="NobyDa&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-9-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/gallery/Bahamut_daily_bonus_js_example.png" alt="巴哈姆特自动签到脚本（适配/开发实例）"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-07-24T12:30:00.000Z" title="2021/7/24 20:30:00">2021-07-24</time>发表</span><span class="level-item"><time dateTime="2021-07-24T12:35:06.581Z" title="2021/7/24 20:35:06">2021-07-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E8%84%9A%E6%9C%AC%E5%BC%80%E5%8F%91/">脚本开发</a></span><span class="level-item">40 分钟读完 (大约5985个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> 次浏览</span></div></div><h1 class="title is-3 is-size-4-mobile">巴哈姆特自动签到脚本（适配/开发实例）</h1><div class="content"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>本文主要记录一次从巴哈姆特自动签到脚本（油猴）适配至可供Surge、QuantumultX运行的开发过程。</p>
<span id="more"></span>

<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>其实这个脚本很久之前就想适配Surge了，之前从Greasyfork搜到这个油猴签到脚本，但是该脚本只能在PC中打开巴哈姆特网页时才能被运行，如果不是每天都逛的话，很容易忘记签到，所以决定适配一下Surge。</p>
<p>当时脚本写了一半，前期测试时发现用户鉴权的Cookie有效期只有1天，这对于大多数自动化签到脚本来说都是致命的，意味着需要频繁去抓Cookie造成毫无使用体验。发现这一情况后并没有深入去研究，而且那段时间也比较忙，所以这个脚本一直处于停滞的状态。</p>
<p>最近在整理脚本时偶然发现这个未完成的脚本，想着可不能半途而废，于是决定深入研究一下巴哈姆特的鉴权方式，顺便分享一下整个过程。</p>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>签到脚本最重要的就是用户鉴权方式，一般来说大多数可以被写成脚本的签到都是请求头带上Cookie字段完成用户鉴权的过程，但该方法弊端很明显，例如有效期过短造成需要频繁的去抓取新Cookie。</p>
<p>而且除了上述情况之外，也不是所有APP/网页签到都可以写成脚本，例如相关请求被加密或者需要算法二次验证；这类情况也很难被写成自动化脚本。</p>
<p>幸运的是本文所描述的巴哈姆特签到并没有被加密，待解决的主要问题是每次签到开始时如何拿到最新的Cookie以避免签到过程中鉴权失败。</p>
<h2 id="鉴权分析"><a href="#鉴权分析" class="headerlink" title="鉴权分析"></a>鉴权分析</h2><p>因为抓取的请求国内无法直连，使用Thor抓包的话需要路由级翻墙，多数用户并没有这个条件。本文为了方便读者实践，将使用Surge进行抓包，抓到以后导入<a target="_blank" rel="noopener" href="https://apps.apple.com/app/id1210562295">Thor</a>分析（因为有完善的关键字过滤且查看方便）最后使用<a target="_blank" rel="noopener" href="https://apps.apple.com/app/id1357644265">Anubis</a>进行重放演示。</p>
<p>既然我们无法使用已经生成好的Cookie，那么我们可以尝试抓取生成Cookie的接口，让脚本每一次运行时都去查询新Cookie，自然就解决了有效期问题。</p>
<p>抓包过程：</p>
<ol>
<li>进入巴哈姆特动画疯APP后，退出登录</li>
<li>打开Surge，MITM主机名输入*:0表示解密所有域名以及所有端口，并开启抓取流量</li>
<li>进入巴哈姆特动画疯APP，输入账号密码登录</li>
<li>返回Surge，关闭抓取流量，并禁用*:0解密</li>
</ol>
<p>抓到请求可以在Surge - 工具 - 已保存的截取数据中找到。</p>
<p>导入Thor：</p>
<p><img src="/2021/07/24/Bahamut_daily_bonus_js_example/bahamut-surge-to-thor.JPEG"></p>
<p>我们导入Thor后，看到请求并不是很多，所以可以简单搜索一下请求URL关键字，例如我们想抓取登录请求，则尝试搜索login</p>
<p><img src="/2021/07/24/Bahamut_daily_bonus_js_example/bahamut-thor-login.JPEG"></p>
<p>搜索后有两条符合的请求，可能有的小伙伴就要问了，你怎么知道搜索这个关键字呢？</p>
<p>答案是经验，抓的包多了，很自然就会知道相关请求的关键字，比如现在抓取的是登录请求，login即为登录的意思。如果关键字搜索不到，则只能凭经验逐条分析，没有什么特别好的办法。</p>
<p>回到正题，我们把搜索到的请求进一步查看请求体以及响应体。</p>
<p><img src="/2021/07/24/Bahamut_daily_bonus_js_example/bahamut-req-rsp.JPEG"></p>
<p>吐槽：写这APP的程序员不行阿，怎么说用户密码也得加密一下。</p>
<p>登录请求体中，uid=为用户账号，passwd=为用户密码，以及各种验证码均以明文显示，响应体则是用户基本信息。</p>
<p>我们的需求是获取新Cookie，然后再看一下这个请求的<strong>响应头</strong>是否返回了Set-Cookie字段</p>
<p><img src="/2021/07/24/Bahamut_daily_bonus_js_example/bahamut-thor-login-rsp-body.JPEG"></p>
<p>可以看到响应头是有返回Set-Cookie的，但缺少了<strong>关键值</strong>，猜测可能是请求头中的Cookie已包含所以不返回。</p>
<p>我们右滑该请求，使用Anubis重放，把请求头中Cookie字段里的一些信息删掉，看看是否会返回完整的Set-Cookie</p>
<p><img src="/2021/07/24/Bahamut_daily_bonus_js_example/bahamut-thor-set-cookie.JPEG"></p>
<p>可以看到，删除请求头Cookie中的部分字段进行重放后，响应头的Set-Cookie返回了关键字段，该字段可用于签到的用户鉴权。</p>
<p>然后再进行重放，精简请求头、请求体的参数，看看哪些是必须的。</p>
<p>经过多次重放调试，可以得知：</p>
<ol>
<li><strong>请求头</strong>中Cookie里的ckBahamutCsrfToken字段需要与<strong>请求体</strong>中的bahamutCsrfToken字段对应</li>
<li><strong>请求头</strong>中Cookie里的ckAPP_VCODE字段需要与<strong>请求体</strong>中的vcode字段对应</li>
<li>除账号密码和以上两个参数不可精简以外，其他都可删除</li>
</ol>
<p>进一步重放后发现请求体中的vcode字段可以自定义，而bahamutCsrfToken字段不行，</p>
<p>vcode字段我们暂且不管，bahamutCsrfToken字段的话，由于该脚本针对大众，如果多个用户使用同一个内容，可能会出现未知问题，所以得想个办法精简掉（虽然不精简也可以）</p>
<p>经过多次尝试无果后，灵光一现，想到了去Github搜索一下这个字段的关键字：</p>
<p><img src="/2021/07/24/Bahamut_daily_bonus_js_example/bahamut-github-search.png"></p>
<p>不得不说Github真是大佬聚集地，点进这个项目后可以看到是一个基于python的巴哈姆特签到项目（瞬间感觉上面抓包抓了个寂寞）</p>
<p>我们进一步查看源码后发现，登录拿Cookie的请求逻辑跟我调试时基本一致，但有几点不同</p>
<p><img src="/2021/07/24/Bahamut_daily_bonus_js_example/bahamut-python-raw.png"></p>
<p>在他的源码中可以看到请求体并没有携带bahamutCsrfToken等参数，并且发现请求URL用的是v3接口，而我抓的是v4</p>
<p>瞬间豁然开朗，v3接口可以省略掉一些参数，经过重放调试后也可以正常返回Set-Cookie。</p>
<p>至此已经解决登录Cookie问题。</p>
<h2 id="适配脚本"><a href="#适配脚本" class="headerlink" title="适配脚本"></a>适配脚本</h2><p>脚本原型为适用于PC浏览器的巴哈姆特签到脚本 (油猴)，项目地址：<a target="_blank" rel="noopener" href="https://github.com/moontai0724/bahamut-auto-sign-script">bahamut-auto-sign-script</a>；</p>
<p>该脚本业务逻辑包括巴哈签到、巴哈公会签到、动画疯答题等。</p>
<p>得益于该项目，省去了自行抓包分析签到等各种过程，在此表示感谢。</p>
<h3 id="应用兼容"><a href="#应用兼容" class="headerlink" title="应用兼容"></a>应用兼容</h3><p>脚本将适配多平台，脚本的写法需要同时兼容多个客户端，那么我们就需要一个兼容函数让它在不同环境下也能被正确执行.</p>
<p>本文将使用chavy大佬的兼容函数。项目地址：<a target="_blank" rel="noopener" href="https://github.com/chavyleung/scripts/blob/master/Env.js">https://github.com/chavyleung/scripts/blob/master/Env.js</a></p>
<p>该兼容函数兼容大多数Surge、QuantumultX、Loon、Shadowrocket的内部API。</p>
<figure class="highlight javascript"><figcaption><span>兼容函数 >folded</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><br><span class="hljs-comment">//太长了，略，可点击以上项目地址查看</span><br><br></code></pre></td></tr></table></figure>



<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><p>写好兼容函数后我们先定义一些全局变量，供所有函数调用.</p>
<figure class="highlight javascript"><figcaption><span>全局变量</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 以下全局变量中的持久化接口为BoxJs预留, 以便修改</span><br><span class="hljs-comment">// 把兼容函数定义到$中, 以便统一调用</span><br><span class="hljs-keyword">const</span> $ = <span class="hljs-keyword">new</span> Env(<span class="hljs-string">&#x27;巴哈姆特&#x27;</span>);<br><br><span class="hljs-comment">// 用户名</span><br>$.uid = $.getdata(<span class="hljs-string">&#x27;@ND_BAHA.ID&#x27;</span>) || <span class="hljs-string">&#x27;YourUserName&#x27;</span>;<br><br><span class="hljs-comment">// 用户密码</span><br>$.pwd = $.getdata(<span class="hljs-string">&#x27;@ND_BAHA.PW&#x27;</span>) || <span class="hljs-string">&#x27;YourUserPassword&#x27;</span>;<br><br><span class="hljs-comment">// 是否自动签到公会，true/false，默认开启</span><br>$.needSignGuild = $.getdata(<span class="hljs-string">&#x27;@ND_BAHA.GUILD&#x27;</span>) || <span class="hljs-literal">true</span>;<br><br><span class="hljs-comment">// 是否自动答题动画疯，true/false，默认开启 (不保证100%答题正确)</span><br>$.needAnswer = $.getdata(<span class="hljs-string">&#x27;@ND_BAHA.ANSWER&#x27;</span>) || <span class="hljs-literal">true</span>;<br><br><span class="hljs-comment">// 为通知准备的空数组</span><br>$.notifyMsg = [];<br></code></pre></td></tr></table></figure>

<h3 id="登录函数"><a href="#登录函数" class="headerlink" title="登录函数"></a>登录函数</h3><p>根据前面的分析，我们只需写一个登录请求即可拿到响应头中的Set-Cookie，请求成功后，后续客户端会自动设置其他同类域名请求的Cookie头字段，无需手动设置。如果登录失败，则终止执行脚本。</p>
<blockquote>
<p><strong>具体实现：</strong></p>
</blockquote>
<figure class="highlight javascript"><figcaption><span>登录函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BahamutLogin</span>(<span class="hljs-params"></span>) </span>&#123; <span class="hljs-comment">//登录函数，拿到Set-Cookie</span><br><br>	<span class="hljs-comment">//登录成功: &#123;&quot;success&quot;:true,&quot;userid&quot;:&quot;DGIE&quot;,&quot;nickname&quot;:&quot;coco&quot;,&quot;gold&quot;:152769,&quot;gp&quot;:0,&quot;avatar&quot;:&quot;https:\/\/avatar2.bahamut.com.tw\/avataruserpic\/dgie.png&quot;,&quot;avatar_s&quot;:&quot;https:\/\/avatar2.bahamut.com.tw\/avataruserpic\/dgie_s.png&quot;,&quot;lv&quot;:6&#125;</span><br>	<span class="hljs-comment">//账号错误: &#123;&quot;code&quot;:0,&quot;message&quot;:&quot;查無此人：SDFOUGB&quot;&#125;</span><br>	<span class="hljs-comment">//密码错误: &#123;&quot;code&quot;:0,&quot;message&quot;:&quot;帳號、密碼或驗證碼錯誤！&quot;&#125;</span><br>	<span class="hljs-comment">//验证码错误: &#123;&quot;code&quot;:0,&quot;message&quot;:&quot;驗證碼錯誤&quot;&#125;</span><br><br>	<span class="hljs-keyword">return</span> $.http.post(&#123; <span class="hljs-comment">//使用post请求查询 (兼容函数实际上返回Promise实例对象,以便后续调用时可以实现顺序执行异步函数)</span><br>			<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://api.gamer.com.tw/mobile_app/user/v3/do_login.php&#x27;</span>, <span class="hljs-comment">//登录接口</span><br>			<span class="hljs-attr">headers</span>: &#123; <span class="hljs-comment">//请求头</span><br>				<span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-string">&#x27;ckAPP_VCODE=6666&#x27;</span> <span class="hljs-comment">//Cookie中的ckAPP_VCODE为必须</span><br>			&#125;,<br>			<span class="hljs-comment">//请求体放入用户名和密码，并把它uri编码</span><br>			<span class="hljs-attr">body</span>: <span class="hljs-string">`uid=<span class="hljs-subst">$&#123;<span class="hljs-built_in">encodeURIComponent</span>($.uid)&#125;</span>&amp;passwd=<span class="hljs-subst">$&#123;<span class="hljs-built_in">encodeURIComponent</span>($.pwd)&#125;</span>&amp;vcode=6666`</span><br>		&#125;)<br>		.then(<span class="hljs-function">(<span class="hljs-params">resp</span>) =&gt;</span> &#123; <span class="hljs-comment">//请求成功的处理</span><br>			<span class="hljs-keyword">const</span> body = <span class="hljs-built_in">JSON</span>.parse(resp.body); <span class="hljs-comment">//解析响应体json为对象</span><br>			<span class="hljs-keyword">if</span> (body.userid) &#123; <span class="hljs-comment">//如果成功返回用户信息</span><br>				$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`✅巴哈姆特登录成功`</span>); <span class="hljs-comment">// 打印日志</span><br>			&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//否则登录失败 (例如密码错误)</span><br>				<span class="hljs-keyword">const</span> failMsg = body.error ? body.error.message : <span class="hljs-literal">null</span>; <span class="hljs-comment">//判断签到失败原因</span><br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`❌登录失败\n❌<span class="hljs-subst">$&#123;body.message||failMsg||<span class="hljs-string">&#x27;未知&#x27;</span>&#125;</span>`</span>); <span class="hljs-comment">//带上原因抛出异常, 脚本结束</span><br>			&#125;<br>		&#125;) <span class="hljs-comment">//未写catch，如果登录失败，例如无法联网、密码错误等, 则被调用该函数时的catch捕获，脚本结束</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="签到函数（巴哈）"><a href="#签到函数（巴哈）" class="headerlink" title="签到函数（巴哈）"></a>签到函数（巴哈）</h3><p>原油猴脚本的业务逻辑为先查询签到Token，再把拿到的Token去请求签到。</p>
<p>造好的轮子适配起来就是舒服，省了抓包；我们直接按照该逻辑去适配。</p>
<blockquote>
<p><strong>具体实现：</strong></p>
</blockquote>
<figure class="highlight javascript"><figcaption><span>巴哈姆特签到函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BahamutSign</span>(<span class="hljs-params"></span>) </span>&#123; <span class="hljs-comment">//查询巴哈姆特签到Token</span><br>	<span class="hljs-keyword">return</span> $.http.get(&#123; <span class="hljs-comment">//使用get方法 (Promise实例对象) 查询签到Token</span><br>			<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://www.gamer.com.tw/ajax/get_csrf_token.php&#x27;</span>, <span class="hljs-comment">// 查询Token接口</span><br>			<span class="hljs-attr">headers</span>: &#123;&#125; <span class="hljs-comment">//请求头, 客户端将自动设置Cookie字段</span><br>		&#125;).then(<span class="hljs-keyword">async</span> (resp) =&gt; &#123; <span class="hljs-comment">//网络请求成功的处理, 实例函数带有async关键字, 表示里面有异步操作</span><br>			<span class="hljs-keyword">if</span> (resp.body) &#123; <span class="hljs-comment">//如果签到Token获取成功</span><br>				$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;✅获取签到令牌成功&#x27;</span>); <span class="hljs-comment">//打印日志</span><br>				<span class="hljs-keyword">const</span> sign = <span class="hljs-keyword">await</span> StartSignBahamut(resp.body); <span class="hljs-comment">//带上Token开始签到</span><br>				$.notifyMsg.push(<span class="hljs-string">`主页签到: 成功, 已连续签到<span class="hljs-subst">$&#123;sign&#125;</span>天`</span>); <span class="hljs-comment">//添加到全局变量备用 (通知)</span><br>			&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//否则抛出异常</span><br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;获取签到令牌失败&#x27;</span>); <span class="hljs-comment">//带上原因被下面catch捕获</span><br>			&#125;<br>		&#125;)<br>		.catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>			$.notifyMsg.push(<span class="hljs-string">`主页签到: <span class="hljs-subst">$&#123;err.message||err&#125;</span>`</span>); <span class="hljs-comment">//添加到全局变量备用 (通知)</span><br>			$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`❌巴哈姆特签到失败`</span>, <span class="hljs-string">`❌<span class="hljs-subst">$&#123;err.message||err&#125;</span>`</span>);<br>		&#125;); <span class="hljs-comment">// 捕获异常, 打印日志</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StartSignBahamut</span>(<span class="hljs-params">token</span>) </span>&#123; <span class="hljs-comment">//巴哈姆特签到</span><br><br>	<span class="hljs-comment">//签到成功: &#123;&quot;data&quot;:&#123;&quot;days&quot;:1,&quot;dialog&quot;:&quot;&quot;,&quot;prjSigninDays&quot;:0&#125;&#125;</span><br>	<span class="hljs-comment">//已签过: &#123;&quot;error&quot;:&#123;&quot;code&quot;:0,&quot;message&quot;:&quot;今天您已經簽到過了喔&quot;,&quot;status&quot;:&quot;&quot;,&quot;details&quot;:[]&#125;&#125;</span><br>	<span class="hljs-comment">//未登录: &#123;&quot;error&quot;:&#123;&quot;code&quot;:401,&quot;message&quot;:&quot;尚未登入&quot;,&quot;status&quot;:&quot;NO_LOGIN&quot;,&quot;details&quot;:[]&#125;&#125;</span><br>	<span class="hljs-comment">//令牌过期: &#123;&quot;error&quot;:&#123;&quot;code&quot;:403,&quot;message&quot;:&quot;網頁已過期&quot;,&quot;status&quot;:&quot;CSRF_TOKEN_ERROR&quot;,&quot;details&quot;:[]&#125;&#125;</span><br><br>	<span class="hljs-keyword">return</span> $.http.post(&#123; <span class="hljs-comment">//使用post方法 (Promise实例对象) 进行签到</span><br>			<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://www.gamer.com.tw/ajax/signin.php&#x27;</span>, <span class="hljs-comment">//巴哈姆特签到接口</span><br>			<span class="hljs-attr">headers</span>: &#123;&#125;, <span class="hljs-comment">//请求头, 客户端将自动设置Cookie字段</span><br>			<span class="hljs-attr">body</span>: <span class="hljs-string">`action=1&amp;token=<span class="hljs-subst">$&#123;token&#125;</span>`</span> <span class="hljs-comment">//请求体带上查询到的签到Token</span><br>		&#125;)<br>		.then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123; <span class="hljs-comment">// 网络请求成功的处理</span><br>			<span class="hljs-keyword">const</span> body = <span class="hljs-built_in">JSON</span>.parse(res.body); <span class="hljs-comment">//解析响应体json为对象</span><br>			<span class="hljs-keyword">if</span> (body.data) &#123; <span class="hljs-comment">// 如果签到成功 (判断预期响应格式)</span><br>				$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;✅巴哈姆特签到成功&#x27;</span>, <span class="hljs-string">`✅已连续签到<span class="hljs-subst">$&#123;body.data.days&#125;</span>天`</span>); <span class="hljs-comment">//打印日志</span><br>				<span class="hljs-keyword">return</span> body.data.days; <span class="hljs-comment">//返回签到天数</span><br>			&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//否则签到失败</span><br>				<span class="hljs-keyword">const</span> failMsg = body.error ? body.error.message : <span class="hljs-literal">null</span>; <span class="hljs-comment">//判断签到失败原因</span><br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(failMsg || body.message || <span class="hljs-string">&#x27;未知&#x27;</span>); <span class="hljs-comment">//带上原因抛出异常</span><br>			&#125;<br>		&#125;); <span class="hljs-comment">//未写catch，如果签到失败或其他错误，则被调用该函数时的catch捕获</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一个函数被调用后，查询签到Token成功后则调用第二个函数；如果这俩任何一环出现错误，则直接跳过该签到，继续运行其他任务。</p>
<h3 id="签到函数（公会）"><a href="#签到函数（公会）" class="headerlink" title="签到函数（公会）"></a>签到函数（公会）</h3><p>原油猴脚本的业务逻辑为先查询已加入公会的ID，再进行签到操作。</p>
<p>我们直接按照该逻辑去适配。</p>
<blockquote>
<p><strong>具体实现：</strong></p>
</blockquote>
<figure class="highlight javascript"><figcaption><span>公会签到函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BahamutGuildSign</span>(<span class="hljs-params"></span>) </span>&#123; <span class="hljs-comment">//巴哈姆特查询公会列表</span><br>	<span class="hljs-keyword">if</span> ($.needSignGuild === <span class="hljs-literal">false</span> || $.needSignGuild === <span class="hljs-string">&#x27;false&#x27;</span>) &#123; <span class="hljs-comment">//如果用户选择不签到公会</span><br>		<span class="hljs-keyword">return</span>; <span class="hljs-comment">//退出公会签到函数</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> $.http.get(&#123; <span class="hljs-comment">//使用get请求查询公会列表 (Promise实例对象)</span><br>			<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://api.gamer.com.tw/ajax/common/topBar.php?type=forum&#x27;</span>, <span class="hljs-comment">// 查询公会列表接口</span><br>			<span class="hljs-attr">headers</span>: &#123;&#125; <span class="hljs-comment">//请求头, 客户端将自动设置Cookie字段</span><br>		&#125;)<br>		.then(<span class="hljs-keyword">async</span> (resp) =&gt; &#123; <span class="hljs-comment">//网络请求成功的处理, 实例函数带有async关键字, 表示里面有异步操作</span><br>			<span class="hljs-keyword">const</span> list = (resp.body.replace(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).match(<span class="hljs-regexp">/guild\.php\?g?sn=\d.+?&lt;\/p&gt;/g</span>) || []) <span class="hljs-comment">//正则过滤公会列表大致内容</span><br>				.map(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> &#123; <span class="hljs-comment">//使用map遍历每个大致内容</span><br>					<span class="hljs-keyword">return</span> &#123; <span class="hljs-comment">//返回包含公会ID和公会名称的对象</span><br>						<span class="hljs-attr">sn</span>: n.split(<span class="hljs-regexp">/guild\.php\?g?sn=(\d+)/</span>)[<span class="hljs-number">1</span>], <span class="hljs-comment">//正则进一步提取公会ID</span><br>						<span class="hljs-attr">name</span>: n.split(<span class="hljs-regexp">/&lt;p&gt;(.+?)&lt;\/p&gt;/</span>)[<span class="hljs-number">1</span>] <span class="hljs-comment">//正则进一步提取公会名称</span><br>					&#125;<br>				&#125;);<br>			<span class="hljs-keyword">if</span> (list.length) &#123; <span class="hljs-comment">//过滤后, 如果包含公会列表</span><br>				$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`✅获取公会列表成功`</span>); <span class="hljs-comment">//打印日志</span><br>				<span class="hljs-comment">//按照公会数量进行并发签到, map结合Promise.all后可以实现并发签到并且都完成后才进行下一行操作</span><br>				<span class="hljs-keyword">const</span> sign = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(list.map(StartSignGuild));<br>				<span class="hljs-keyword">const</span> sucs = sign.filter(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n === <span class="hljs-number">1</span>).length; <span class="hljs-comment">//过滤后得到成功数量</span><br>				<span class="hljs-keyword">const</span> fail = sign.filter(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n === <span class="hljs-number">0</span>).length; <span class="hljs-comment">//过滤后得到失败数量</span><br>				<span class="hljs-comment">//添加到全局变量备用 (通知)</span><br>				$.notifyMsg.push(<span class="hljs-string">`公会签到: <span class="hljs-subst">$&#123;sucs?<span class="hljs-string">`成功<span class="hljs-subst">$&#123;sucs&#125;</span>个`</span>:<span class="hljs-string">``</span>&#125;</span><span class="hljs-subst">$&#123;sucs&amp;&amp;fail?<span class="hljs-string">`, `</span>:<span class="hljs-string">``</span>&#125;</span><span class="hljs-subst">$&#123;fail?<span class="hljs-string">`失败<span class="hljs-subst">$&#123;fail&#125;</span>个`</span>:<span class="hljs-string">``</span>&#125;</span>`</span>);<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;公会列表为空&#x27;</span>); <span class="hljs-comment">//无公会列表则抛出异常</span><br>			&#125;<br>		&#125;)<br>		.catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123; <span class="hljs-comment">//捕获异常, 打印日志</span><br>			$.notifyMsg.push(<span class="hljs-string">`公会签到: <span class="hljs-subst">$&#123;err.message || err&#125;</span>`</span>); <span class="hljs-comment">//添加到全局变量备用 (通知)</span><br>			$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`❌巴哈姆特公会签到失败`</span>, <span class="hljs-string">`❌<span class="hljs-subst">$&#123;err.message || err&#125;</span>`</span>); <span class="hljs-comment">//打印日志</span><br>		&#125;);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StartSignGuild</span>(<span class="hljs-params">v</span>) </span>&#123; <span class="hljs-comment">//巴哈姆特公会签到</span><br><br>	<span class="hljs-comment">//签到成功: &#123;&quot;ok&quot;:1,&quot;msg&quot;:&quot;本日簽到成功！獲得5貢獻度&quot;&#125;</span><br>	<span class="hljs-comment">//已签过: &#123;&quot;error&quot;:1,&quot;msg&quot;:&quot;您今天已經簽到過了！&quot;&#125;</span><br>	<span class="hljs-comment">//公会ID错误: &#123;&quot;error&quot;:1,&quot;msg&quot;:&quot;此公會社團不存在。&quot;&#125;</span><br>	<span class="hljs-comment">//未加入公会: &#123;&quot;error&quot;:1,&quot;msg&quot;:&quot;你還不是成員，歡迎加入！&quot;&#125;</span><br>	<span class="hljs-comment">//未登录: &#123;&quot;error&quot;:1,&quot;msg&quot;:&quot;請先登入&quot;&#125;</span><br><br>	<span class="hljs-keyword">return</span> $.http.post(&#123; <span class="hljs-comment">//使用post方法签到公会 (Promise实例对象)</span><br>			<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://guild.gamer.com.tw/ajax/guildSign.php&#x27;</span>, <span class="hljs-comment">//公会签到接口</span><br>			<span class="hljs-attr">headers</span>: &#123;&#125;, <span class="hljs-comment">//请求头, 客户端将自动设置Cookie字段</span><br>			<span class="hljs-attr">body</span>: <span class="hljs-string">`sn=<span class="hljs-subst">$&#123;v.sn&#125;</span>`</span> <span class="hljs-comment">//把查询到的公会ID放进请求体</span><br>		&#125;)<br>		.then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123; <span class="hljs-comment">//网络请求成功后的处理</span><br>			<span class="hljs-keyword">const</span> body = <span class="hljs-built_in">JSON</span>.parse(res.body); <span class="hljs-comment">//解析响应体json为对象</span><br>			$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`🔷&lt;<span class="hljs-subst">$&#123;v.name&#125;</span>&gt;`</span>, <span class="hljs-string">`<span class="hljs-subst">$&#123;body.ok?<span class="hljs-string">`✅`</span>:<span class="hljs-string">`❌`</span>&#125;</span><span class="hljs-subst">$&#123;body.msg&#125;</span>`</span>); <span class="hljs-comment">//打印日志, 包含签到结果</span><br>			<span class="hljs-keyword">if</span> (body.ok) &#123; <span class="hljs-comment">//如果签到成功</span><br>				<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; <span class="hljs-comment">//返回1表示成功</span><br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">//返回0表示失败</span><br>			&#125;<br>		&#125;)<br>		.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123; <span class="hljs-comment">//捕获异常, 打印日志</span><br>			$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`🔷&lt;<span class="hljs-subst">$&#123;v.name&#125;</span>&gt;`</span>, <span class="hljs-string">`❌签到失败: <span class="hljs-subst">$&#123;e.message||e&#125;</span>`</span>);<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">//返回0表示失败</span><br>		&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一个函数被调用后，首先判断用户是否开启公会签到，如果开启则先查询已加入公会的ID，查询成功后再调用第二个函数并发签到。</p>
<p>如果用户选择关闭公会签到或者查询公会ID失败，则直接退出该签到，继续运行其他任务。</p>
<h3 id="答题函数（动画疯）"><a href="#答题函数（动画疯）" class="headerlink" title="答题函数（动画疯）"></a>答题函数（动画疯）</h3><p>原油猴脚本的答题逻辑稍微有点复杂，简单概括就是默认手动答题 (浏览器)，如果开启自动答题，则先查询题目，查询成功后：</p>
<ol>
<li>从<a target="_blank" rel="noopener" href="https://home.gamer.com.tw/creation.php?owner=blackxblue">blackxblue的小屋</a>获取今日答案的文章ID</li>
<li>如果找到文章ID，则查询该文章内容找到答案</li>
<li>如果以上获取失败，则调用<a target="_blank" rel="noopener" href="https://github.com/moontai0724/bahamut-quiz-script">moontai0724的题库</a>寻找答案（耗时过长）</li>
</ol>
<p>所以我们适配时将直接从<a target="_blank" rel="noopener" href="https://home.gamer.com.tw/creation.php?owner=blackxblue">blackxblue的小屋</a>获取答案，获取失败则跳过该任务</p>
<blockquote>
<p><strong>具体实现：</strong></p>
</blockquote>
<figure class="highlight javascript"><figcaption><span>动画疯答题函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BahamutAnswer</span>(<span class="hljs-params"></span>) </span>&#123; <span class="hljs-comment">//动画疯答题</span><br><br>	<span class="hljs-comment">//未答题: &#123;&quot;game&quot;:&quot;灌籃高手&quot;,&quot;question&quot;:&quot;流川楓的號碼是下列何者？&quot;,&quot;a1&quot;:&quot;7&quot;,&quot;a2&quot;:&quot;11&quot;,&quot;a3&quot;:&quot;23&quot;,&quot;a4&quot;:&quot;59&quot;,&quot;userid&quot;:&quot;GN32964174&quot;,&quot;token&quot;:&quot;01092fe463ab36ab47cb298e229c4f8fb298e229cc260fa7baf&quot;&#125;</span><br>	<span class="hljs-comment">//已答题: &#123;&quot;error&quot;:1,&quot;msg&quot;:&quot;今日已經答過題目了，一天僅限一次機會&quot;&#125;</span><br>	<span class="hljs-comment">//未登录: &#123;&quot;error&quot;:1,&quot;nologin&quot;:1,&quot;msg&quot;:&quot;請先登入&quot;&#125;</span><br><br>	<span class="hljs-keyword">if</span> ($.needAnswer === <span class="hljs-literal">false</span> || $.needAnswer === <span class="hljs-string">&#x27;false&#x27;</span>) &#123; <span class="hljs-comment">//如果用户关闭动画疯答题</span><br>		<span class="hljs-keyword">return</span>; <span class="hljs-comment">//退出答题函数</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> $.http.get(&#123; <span class="hljs-comment">//使用get方获取题目 (Promise实例对象)</span><br>			<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://ani.gamer.com.tw/ajax/animeGetQuestion.php?t=&#x27;</span> + <span class="hljs-built_in">Date</span>.now(), <span class="hljs-comment">//获取题目接口</span><br>			<span class="hljs-attr">headers</span>: &#123;&#125; <span class="hljs-comment">//请求头, 客户端将自动设置Cookie字段</span><br>		&#125;)<br>		.then(<span class="hljs-keyword">async</span> (res) =&gt; &#123; <span class="hljs-comment">//网络请求成功的处理, 实例函数带有async关键字, 表示里面有异步操作</span><br>			<span class="hljs-keyword">const</span> r = <span class="hljs-built_in">JSON</span>.parse(res.body); <span class="hljs-comment">//解析响应体json为对象</span><br>			<span class="hljs-keyword">if</span> (r.token) &#123; <span class="hljs-comment">//如果有题目</span><br>				$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`✅获取动画疯题目成功`</span>, <span class="hljs-string">``</span>, <span class="hljs-string">`🔶&lt;<span class="hljs-subst">$&#123;r.game&#125;</span>&gt; <span class="hljs-subst">$&#123;r.question&#125;</span>`</span>,<br>					<span class="hljs-string">`1️⃣<span class="hljs-subst">$&#123;r.a1&#125;</span>`</span>, <span class="hljs-string">`2️⃣<span class="hljs-subst">$&#123;r.a2&#125;</span>`</span>, <span class="hljs-string">`3️⃣<span class="hljs-subst">$&#123;r.a3&#125;</span>`</span>, <span class="hljs-string">`4️⃣<span class="hljs-subst">$&#123;r.a4&#125;</span>`</span>); <span class="hljs-comment">//打印日志</span><br>				<span class="hljs-keyword">const</span> article = <span class="hljs-keyword">await</span> GetAanswerArticles(); <span class="hljs-comment">//获取答案文章ID</span><br>				<span class="hljs-keyword">const</span> getAnswer = <span class="hljs-keyword">await</span> StartSearchAnswers(article); <span class="hljs-comment">//传入文章ID, 再从文章内获取答案</span><br>				<span class="hljs-keyword">const</span> sendAnswer = <span class="hljs-keyword">await</span> StartBahamutAnswer(getAnswer, r.token); <span class="hljs-comment">//传入答案和题目令牌, 开始答题</span><br>				$.notifyMsg.push(<span class="hljs-string">`动画答题: <span class="hljs-subst">$&#123;sendAnswer&#125;</span>`</span>); <span class="hljs-comment">//答题后的结果添加到全局变量备用 (通知)</span><br>			&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//未获取到题目</span><br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(r.msg || <span class="hljs-string">`获取题目失败`</span>); <span class="hljs-comment">//带上原因抛出异常</span><br>			&#125;<br>		&#125;)<br>		.catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123; <span class="hljs-comment">//捕获异常, 打印日志</span><br>			$.notifyMsg.push(<span class="hljs-string">`动画答题: <span class="hljs-subst">$&#123;e.message||e||<span class="hljs-string">`失败`</span>&#125;</span>`</span>); <span class="hljs-comment">//添加到全局变量备用 (通知)</span><br>			$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`❌动画疯答题失败`</span>, <span class="hljs-string">`❌<span class="hljs-subst">$&#123;e.message||e&#125;</span>`</span>); <span class="hljs-comment">//打印日志</span><br>		&#125;);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GetAanswerArticles</span>(<span class="hljs-params"></span>) </span>&#123; <span class="hljs-comment">// 从blackxblue的小屋查询含答案的文章ID</span><br>	$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`🔶开始获取文章`</span>); <span class="hljs-comment">//打印日志</span><br>	<span class="hljs-keyword">return</span> $.http.get(&#123; <span class="hljs-comment">//使用get方法获取文章ID (Promise实例对象)</span><br>			<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://api.gamer.com.tw/mobile_app/bahamut/v1/home.php?owner=blackXblue&amp;page=1&#x27;</span>, <span class="hljs-comment">//获取文章ID接口</span><br>			<span class="hljs-attr">headers</span>: &#123;&#125;<br>		&#125;)<br>		.then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123; <span class="hljs-comment">//网络请求成功后的处理</span><br>			<span class="hljs-keyword">const</span> body = <span class="hljs-built_in">JSON</span>.parse(res.body); <span class="hljs-comment">//解析响应体json为对象</span><br>			<span class="hljs-keyword">const</span> tDate = $.time(<span class="hljs-string">&#x27;MM/dd&#x27;</span>); <span class="hljs-comment">//返回今日日期</span><br>			<span class="hljs-keyword">const</span> title = (body.creation || []).filter(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.title.includes(tDate)); <span class="hljs-comment">//过滤后返回今日答案文章</span><br>			<span class="hljs-keyword">if</span> (title.length &amp;&amp; title[<span class="hljs-number">0</span>].sn) &#123; <span class="hljs-comment">//如果有答案文章</span><br>				$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`✅获取文章成功 (<span class="hljs-subst">$&#123;title[<span class="hljs-number">0</span>].sn&#125;</span>)`</span>); <span class="hljs-comment">//打印日志</span><br>				<span class="hljs-keyword">return</span> title[<span class="hljs-number">0</span>].sn; <span class="hljs-comment">//返回文章ID</span><br>			&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//否则带上原因抛出异常, 被调用该函数时的catch捕获</span><br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;今日答案未发表&#x27;</span>);<br>			&#125;<br>		&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StartSearchAnswers</span>(<span class="hljs-params">id</span>) </span>&#123; <span class="hljs-comment">//获取文章内答案</span><br>	$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`🔶开始获取答案`</span>); <span class="hljs-comment">//打印日志</span><br>	<span class="hljs-keyword">return</span> $.http.get(&#123; <span class="hljs-comment">//使用get方法获取答案 (Promise实例对象)</span><br>			<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://api.gamer.com.tw/mobile_app/bahamut/v1/home_creation_detail.php?sn=&#x27;</span> + id, <span class="hljs-comment">//获取答案接口</span><br>			<span class="hljs-attr">headers</span>: &#123;&#125;<br>		&#125;)<br>		.then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123; <span class="hljs-comment">//网络请求成功后的处理</span><br>			<span class="hljs-keyword">const</span> body = <span class="hljs-built_in">JSON</span>.parse(res.body); <span class="hljs-comment">//解析响应体json为对象</span><br>			<span class="hljs-keyword">const</span> answers = body.content.split(<span class="hljs-regexp">/A:(\d)/</span>)[<span class="hljs-number">1</span>]; <span class="hljs-comment">//正则提取答案</span><br>			<span class="hljs-keyword">if</span> (answers) &#123; <span class="hljs-comment">//如果成功提取答案</span><br>				$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`✅获取答案成功 (<span class="hljs-subst">$&#123;answers&#125;</span>)`</span>); <span class="hljs-comment">//打印日志</span><br>				<span class="hljs-keyword">return</span> answers; <span class="hljs-comment">//返回答案</span><br>			&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//否则带上原因抛出异常, 被调用该函数时的catch捕获</span><br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&#x27;提取答案失败&#x27;</span>);<br>			&#125;<br>		&#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">StartBahamutAnswer</span>(<span class="hljs-params">answer, token</span>) </span>&#123; <span class="hljs-comment">//动画疯答题</span><br><br>	<span class="hljs-comment">//答题正确: &#123;&quot;ok&quot;:1,&quot;gift&quot;:&quot;恭喜您得到：300 巴幣&quot;&#125;</span><br>	<span class="hljs-comment">//答题错误: &#123;&quot;error&quot;:1,&quot;msg&quot;:&quot;答題錯誤&quot;&#125;</span><br>	<span class="hljs-comment">//令牌过期: &#123;&quot;error&quot;:1,&quot;msg&quot;:&quot;很抱歉！本題目已超過時效！&quot;&#125;</span><br>	<span class="hljs-comment">//已答题: &#123;&quot;error&quot;:1,&quot;msg&quot;:&quot;今日已經答過題目了，一天僅限一次機會&quot;&#125;</span><br>	<span class="hljs-comment">//未登录: &#123;&quot;error&quot;:1,&quot;nologin&quot;:1,&quot;msg&quot;:&quot;請先登入&quot;&#125;</span><br><br>	$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`🔶开始答题`</span>); <span class="hljs-comment">//打印日志</span><br>	<span class="hljs-keyword">return</span> $.http.post(&#123; <span class="hljs-comment">//使用post方法提交答案 (Promise实例对象)</span><br>			<span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://ani.gamer.com.tw/ajax/animeAnsQuestion.php&#x27;</span>, <span class="hljs-comment">//提交答案接口</span><br>			<span class="hljs-attr">headers</span>: &#123;&#125;, <span class="hljs-comment">//请求头, 客户端将自动设置Cookie字段</span><br>			<span class="hljs-attr">body</span>: <span class="hljs-string">`token=<span class="hljs-subst">$&#123;token&#125;</span>&amp;ans=<span class="hljs-subst">$&#123;answer&#125;</span>&amp;t=<span class="hljs-subst">$&#123;<span class="hljs-built_in">Date</span>.now()&#125;</span>`</span>, <span class="hljs-comment">//请求体带上答案和答案令牌</span><br>		&#125;)<br>		.then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123; <span class="hljs-comment">//网络请求成功后的处理</span><br>			<span class="hljs-keyword">const</span> body = <span class="hljs-built_in">JSON</span>.parse(res.body); <span class="hljs-comment">//解析响应体json为对象</span><br>			<span class="hljs-keyword">if</span> (body.ok) &#123; <span class="hljs-comment">//如果答题成功</span><br>				$.log(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">`✅<span class="hljs-subst">$&#123;body.gift&#125;</span>`</span>); <span class="hljs-comment">//打印奖励日志</span><br>				<span class="hljs-keyword">return</span> body.gift; <span class="hljs-comment">//返回奖励内容</span><br>			&#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//否则答题失败</span><br>				<span class="hljs-keyword">const</span> failMsg = body.error ? body.error.message : <span class="hljs-literal">null</span>; <span class="hljs-comment">//提取签到失败原因</span><br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(body.msg || failMsg || <span class="hljs-string">&#x27;未知&#x27;</span>); <span class="hljs-comment">//否则带上原因抛出异常, 被调用该函数时的catch捕获</span><br>			&#125;<br>		&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>共有四个函数，第一个函数被调用后首先查询题目，如果查询成功：</p>
<ol>
<li>调用第二个函数从<a target="_blank" rel="noopener" href="https://home.gamer.com.tw/creation.php?owner=blackxblue">blackxblue的小屋</a>查询今日答案的文章ID</li>
<li>调用第三个函数查询文章内的答案</li>
<li>调用第四个函数则进行答题</li>
</ol>
<p>如果以上任一环节查询失败，则不会再继续执行其余函数，跳过动画疯答题。</p>
<h3 id="统一调用"><a href="#统一调用" class="headerlink" title="统一调用"></a>统一调用</h3><p>写好函数后，如果不进行调用，那么代码是无法被运行的.</p>
<p>在javascript中，代码的执行顺序很重要，我们的需求是先完成一个任务后再进行下一个任务，最后退出脚本.</p>
<p>以下匿名函数将按我们预期的顺序执行.</p>
<figure class="highlight javascript"><figcaption><span>匿名异步函数</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript">(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123; <span class="hljs-comment">// 立即运行的匿名异步函数</span><br>	<span class="hljs-keyword">await</span> BahamutLogin(); <span class="hljs-comment">// 登录</span><br>	<span class="hljs-keyword">await</span> BahamutGuildSign(); <span class="hljs-comment">//签到巴哈公会</span><br>	<span class="hljs-keyword">await</span> BahamutSign(); <span class="hljs-comment">//签到巴哈</span><br>	<span class="hljs-keyword">await</span> BahamutAnswer(); <span class="hljs-comment">//动画疯答题</span><br>&#125;)().catch(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> $.notifyMsg.push(e.message || e)) <span class="hljs-comment">//捕获登录函数等抛出的异常, 并把原因添加到全局变量(通知)</span><br>	.finally(<span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">//finally在catch之后无论有无异常都会执行</span><br>		$.msg(<span class="hljs-string">`巴哈姆特`</span>, <span class="hljs-string">``</span>, $.notifyMsg.join(<span class="hljs-string">&#x27;\n&#x27;</span>), &#123;<br>			<span class="hljs-string">&#x27;open-url&#x27;</span>: <span class="hljs-string">&#x27;crazyanime://&#x27;</span>, <span class="hljs-comment">//动画疯url scheme</span><br>			<span class="hljs-string">&#x27;media-url&#x27;</span>: <span class="hljs-string">&#x27;https://cdn.jsdelivr.net/gh/NobyDa/mini@master/Color/bahamutClear.png&#x27;</span> <span class="hljs-comment">//通知图片</span><br>		&#125;); <span class="hljs-comment">//带上总结推送通知</span><br>		$.done(); <span class="hljs-comment">//调用Surge、QX内部特有的函数, 用于退出脚本执行</span><br>	&#125;);<br></code></pre></td></tr></table></figure>

<p>至此脚本适配已完成。</p>
<h2 id="配置任务"><a href="#配置任务" class="headerlink" title="配置任务"></a>配置任务</h2><p>我们写好脚本后，就可以在Surge或QuantumultX里配置定时任务让它在规定时间内执行该脚本.</p>
<p>以下将用Surge进行演示</p>
<blockquote>
<p><strong>编辑Surge配置文件，在[Script]段落放入以下脚本</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">巴哈姆特签到 = type=cron,cronexp=&quot;0 8 * * *&quot;,wake-system=1,timeout=30,script-path=https://raw.githubusercontent.com/NobyDa/Script/master/Bahamut/BahamutDailyBonus.js<br></code></pre></td></tr></table></figure>

<p>以上配置将在每天的早上8:00执行。</p>
<p>有几点需要注意：</p>
<ol>
<li>需要进入BoxJs填写账号密码，或者手动填入脚本（全局变量）</li>
<li>脚本不建议在凌晨执行（需要获取<a target="_blank" rel="noopener" href="https://home.gamer.com.tw/creation.php?owner=blackxblue">blackxblue</a>发布的动画疯答案）</li>
<li>脚本兼容Surge、QuantumultX、Loon、Shadowrocket 以及 Node.js (需安装got、tough-cookie模块)</li>
</ol>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>虽然油猴版巴哈姆特签到并非鄙人原创，但二次适配起来并不亚于重构整个脚本，脚本的逻辑也需要重新设计。</p>
<p>教学类型文章不可避免会有一些专业性，抓包部分对于初学者来说并不难，脚本部分也包含大量的注释供读者理解执行逻辑。</p>
<p>俗话说：授人以鱼不如授人以渔，授之以渔可解一生之需；</p>
<p>祝大家学成归来。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>巴哈姆特自动签到脚本（适配/开发实例）</p><p><a href="https://nobyda.github.io/2021/07/24/Bahamut_daily_bonus_js_example/">https://nobyda.github.io/2021/07/24/Bahamut_daily_bonus_js_example/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>NobyDa</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-07-24</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-07-24</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Surge/">Surge</a><a class="link-muted mr-2" rel="tag" href="/tags/QuantumultX/">QuantumultX</a><a class="link-muted mr-2" rel="tag" href="/tags/JavaScript/">JavaScript</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=60bb78906cfa7d00118e7e9e&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/donates.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/07/29/Javascript-TOTP-algorithm/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">适用于Surge &amp; QuantumultX的一次性密码生成脚本 (TOTP)</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/07/16/BilibiliManga_Js_example/"><span class="level-item">记录一次Surge &amp; QuantumultX 脚本开发过程</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "68d06be97a38faee5e9b6dfa6a4c953e",
            repo: "NobyDa.github.io",
            owner: "NobyDa",
            clientID: "84cc10757e7c7631cf71",
            clientSecret: "095f8b47cbdb5b1ef38709e44e7186cd951362b9",
            admin: ["NobyDa"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "first",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-3-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#简介"><span class="level-left"><span class="level-item">1</span><span class="level-item">简介</span></span></a></li><li><a class="level is-mobile" href="#背景"><span class="level-left"><span class="level-item">2</span><span class="level-item">背景</span></span></a></li><li><a class="level is-mobile" href="#过程"><span class="level-left"><span class="level-item">3</span><span class="level-item">过程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#鉴权分析"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">鉴权分析</span></span></a></li><li><a class="level is-mobile" href="#适配脚本"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">适配脚本</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#应用兼容"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">应用兼容</span></span></a></li><li><a class="level is-mobile" href="#全局变量"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">全局变量</span></span></a></li><li><a class="level is-mobile" href="#登录函数"><span class="level-left"><span class="level-item">3.2.3</span><span class="level-item">登录函数</span></span></a></li><li><a class="level is-mobile" href="#签到函数（巴哈）"><span class="level-left"><span class="level-item">3.2.4</span><span class="level-item">签到函数（巴哈）</span></span></a></li><li><a class="level is-mobile" href="#签到函数（公会）"><span class="level-left"><span class="level-item">3.2.5</span><span class="level-item">签到函数（公会）</span></span></a></li><li><a class="level is-mobile" href="#答题函数（动画疯）"><span class="level-left"><span class="level-item">3.2.6</span><span class="level-item">答题函数（动画疯）</span></span></a></li><li><a class="level is-mobile" href="#统一调用"><span class="level-left"><span class="level-item">3.2.7</span><span class="level-item">统一调用</span></span></a></li></ul></li><li><a class="level is-mobile" href="#配置任务"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">配置任务</span></span></a></li></ul></li><li><a class="level is-mobile" href="#后记"><span class="level-left"><span class="level-item">4</span><span class="level-item">后记</span></span></a></li></ul></div></div><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"></a><p class="is-size-7"><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span><br><span>&copy; 2024 NobyDa's Blog is</span> powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>